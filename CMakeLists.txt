cmake_minimum_required(VERSION 3.24)
project(EIMTimeStretchers)

set(CMAKE_CXX_STANDARD 23)

add_definitions(-DNO_TIMING)

if (WIN32)
    add_definitions(-D_WIN32 -DNOMINMAX -D_USE_MATH_DEFINES -DHAVE_SLEEF -DHAVE_LIBSAMPLERATE -DGETOPT_API=0)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MD")

    set(sleef_SOURCE_DIR ${CMAKE_SOURCE_DIR}/sleef)
    set(sleef_BINARY_DIR ${CMAKE_BINARY_DIR}/sleef)
    set(BUILD_DFT ON CACHE BOOL "" FORCE)
    add_subdirectory("sleef")
    include_directories(${sleef_BINARY_DIR}/include)
    include_directories(${sleef_SOURCE_DIR}/include)
    link_directories(${sleef_BINARY_DIR}/lib)
    set(CMAKE_PROJECT_VERSION 2.3.2)
elseif (APPLE)
    add_definitions(-DHAVE_LIBSAMPLERATE -DHAVE_VDSP -DNO_THREAD_CHECKS -DUSE_PTHREADS -DMALLOC_IS_ALIGNED)
endif ()

# check is Release build or MinSizeRel build
if (CMAKE_BUILD_TYPE MATCHES Release OR CMAKE_BUILD_TYPE MATCHES MinSizeRel)
    add_definitions(-DNDEBUG -DNO_THREAD_CHECKS)
    
    if (NOT MSVC)
        SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -ffast-math -ftree-vectorize")
    endif()
endif()

add_subdirectory(libsamplerate)
add_subdirectory(soundtouch)
include_directories(stubs)

file(GLOB_RECURSE SRC_FILES src/*.cpp src/*.h)
file(GLOB_RECURSE RUBBERBAND_SRC_FILES
        rubberband/src/common/*.cpp rubberband/src/common/*.h
        rubberband/src/finer/*.cpp rubberband/src/finer/*.h
        rubberband/src/faster/*.cpp rubberband/src/faster/*.h
        rubberband/src/ext/*.cpp rubberband/src/ext/*.h
        rubberband/rubberband/RubberBandStretcher.h rubberband/src/RubberBandStretcher.cpp
)

add_library(EIMTimeStretchers SHARED ${SRC_FILES} ${RUBBERBAND_SRC_FILES})
#add_executable(EIMTimeStretchers ${SRC_FILES} ${RUBBERBAND_SRC_FILES})

if (WIN32)
    add_dependencies(EIMTimeStretchers sleef)
    target_link_libraries(EIMTimeStretchers PRIVATE SoundTouch sleef sleefdft samplerate)
elseif (APPLE)
    target_link_libraries(EIMTimeStretchers PRIVATE "-framework Accelerate" SoundTouch pthread samplerate)
endif ()
